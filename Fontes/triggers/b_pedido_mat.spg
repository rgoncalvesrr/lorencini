/**
   Valida inclusão do item no pedido

	@author  Ricardo Gonçalves
	@date    17/06/2018
	@trigger ped_mat B IUD

	Histórico
	---------------------------------------------------------------------------------------------------------------------
   Legenda: [-] - Correção / [*] - Recurso modificado/melhorado / [+] - Implementação de recurso
*/
CREATE OR REPLACE FUNCTION b_pedido_mat()
  RETURNS trigger AS
$$
BEGIN
   if tg_op <> 'DELETE' then
      if tg_op = 'INSERT' then
         -- Valida inclusão do item
         if not exists(
            select 1
              from pedido c
                   join orca_grupo o
                     on o.recno = c.grupo
                    and o.reqmat
             where c.recno = new.pedido)
         then
            raise '[[O pedido % não suporta a inclusão de materiais!]]', new.pedido;
         end if;
      end if;

      new.vtotal := new.qtd * new.vvenda;      
      
      return new;
   else
      return old;
   end if;
END;
$$
  LANGUAGE 'plpgsql' VOLATILE;